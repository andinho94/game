<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1a0000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>STDP ACADEMY</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        
        :root {
            --primary: #f00;
            --secondary: #ff0;
            --accent: #0ff;
            --success: #0f0;
            --danger: #f00;
            --bg-dark: #000;
            --bg-card: #110000;
            --bg-elevated: #1a0000;
            --border-subtle: #330000;
            --text-muted: #666;
            
            --space-xs: 4px;
            --space-sm: 8px;
            --space-md: 12px;
            --space-lg: 16px;
            --space-xl: 24px;
            --space-2xl: 32px;
            
            --touch-target: 44px;
            --border-width: 3px;
            --radius-sm: 4px;
            --radius-md: 8px;
            
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
            --safe-left: env(safe-area-inset-left, 0px);
            --safe-right: env(safe-area-inset-right, 0px);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }
        
        html {
            font-size: 16px;
            scroll-behavior: smooth;
        }
        
        body {
            font-family: 'Press Start 2P', cursive;
            background: var(--bg-dark);
            color: var(--primary);
            min-height: 100vh;
            min-height: 100dvh;
            overflow-x: hidden;
            padding-bottom: calc(70px + var(--safe-bottom));
        }
        
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 0, 0, 0.08),
                rgba(0, 0, 0, 0.08) 1px,
                transparent 1px,
                transparent 2px
            );
            pointer-events: none;
            z-index: 9999;
        }
        
        .header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: var(--space-md);
            padding-top: calc(var(--space-md) + var(--safe-top));
            border-bottom: var(--border-width) solid var(--primary);
        }
        
        .header-content {
            max-width: 600px;
            margin: 0 auto;
        }
        
        .title {
            font-size: 9px;
            color: var(--primary);
            text-shadow: 2px 2px var(--secondary), 0 0 20px rgba(255, 0, 0, 0.5);
            text-align: center;
            margin-bottom: var(--space-xs);
            letter-spacing: 0.5px;
        }
        
        .subtitle {
            font-size: 6px;
            color: var(--secondary);
            text-align: center;
            margin-bottom: var(--space-md);
            opacity: 0.8;
        }
        
        .xp-section {
            margin-bottom: var(--space-sm);
        }
        
        .xp-bar-outer {
            background: var(--border-subtle);
            border: 2px solid var(--primary);
            border-radius: var(--radius-sm);
            height: 18px;
            position: relative;
            overflow: hidden;
        }
        
        .xp-bar-fill {
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            height: 100%;
            width: 0%;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        
        .xp-bar-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .xp-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 7px;
            color: #fff;
            text-shadow: 1px 1px 2px #000;
            white-space: nowrap;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--space-xs);
            text-align: center;
        }
        
        .stat-box {
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            padding: var(--space-xs) var(--space-sm);
        }
        
        .stat-label {
            font-size: 5px;
            color: var(--text-muted);
            margin-bottom: 2px;
        }
        
        .stat-value {
            font-size: 9px;
            color: var(--secondary);
        }
        
        .main-content {
            padding: var(--space-md);
            padding-left: calc(var(--space-md) + var(--safe-left));
            padding-right: calc(var(--space-md) + var(--safe-right));
            max-width: 600px;
            margin: 0 auto;
        }
        
        .path-indicator {
            text-align: center;
            font-size: 7px;
            color: var(--text-muted);
            margin-bottom: var(--space-md);
            padding: var(--space-sm);
            border: 1px dashed var(--border-subtle);
            border-radius: var(--radius-sm);
        }
        
        .path-name {
            color: var(--secondary);
            font-size: 8px;
        }
        
        .skill-grid {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }
        
        .skill-card {
            background: var(--bg-card);
            border: var(--border-width) solid var(--border-subtle);
            border-radius: var(--radius-md);
            padding: var(--space-lg);
            display: flex;
            align-items: center;
            gap: var(--space-md);
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
            min-height: var(--touch-target);
        }
        
        .skill-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--border-subtle);
            transition: background 0.2s;
        }
        
        .skill-card.unlocked {
            border-color: var(--primary);
        }
        
        .skill-card.unlocked::before {
            background: var(--primary);
        }
        
        .skill-card.unlocked:active {
            transform: scale(0.98);
            background: var(--bg-elevated);
        }
        
        .skill-card.completed {
            border-color: var(--secondary);
            background: rgba(255, 255, 0, 0.03);
        }
        
        .skill-card.completed::before {
            background: var(--secondary);
        }
        
        .skill-card.locked {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .skill-icon {
            font-size: 28px;
            flex-shrink: 0;
            width: 40px;
            text-align: center;
        }
        
        .skill-info {
            flex: 1;
            min-width: 0;
        }
        
        .skill-title {
            font-size: 8px;
            color: var(--primary);
            margin-bottom: var(--space-xs);
            line-height: 1.4;
        }
        
        .skill-card.completed .skill-title {
            color: var(--secondary);
        }
        
        .skill-meta {
            display: flex;
            gap: var(--space-sm);
            font-size: 6px;
            color: var(--text-muted);
        }
        
        .skill-xp {
            color: var(--secondary);
        }
        
        .skill-status {
            margin-left: auto;
            font-size: 16px;
        }
        
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.98);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-top: var(--border-width) solid var(--primary);
            padding: var(--space-sm);
            padding-bottom: calc(var(--space-sm) + var(--safe-bottom));
            z-index: 100;
        }
        
        .nav-buttons {
            display: flex;
            justify-content: space-around;
            max-width: 400px;
            margin: 0 auto;
        }
        
        .nav-btn {
            background: transparent;
            border: none;
            color: var(--primary);
            font-family: inherit;
            font-size: 6px;
            padding: var(--space-sm);
            min-width: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: var(--radius-sm);
        }
        
        .nav-btn:active {
            background: rgba(255, 0, 0, 0.1);
            transform: scale(0.95);
        }
        
        .nav-btn .icon {
            font-size: 20px;
        }
        
        .nav-btn.home-btn {
            color: var(--secondary);
        }
        
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-dark);
            z-index: 1000;
            overflow-y: scroll;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior-y: contain;
        }
        
        .modal-overlay.active {
            display: block;
            animation: fadeIn 0.2s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            min-height: 100%;
            padding: var(--space-lg);
            padding-top: calc(var(--space-lg) + var(--safe-top));
            padding-bottom: calc(100px + var(--safe-bottom));
            max-width: 600px;
            margin: 0 auto;
        }
        
        .lesson-header {
            text-align: center;
            margin-bottom: var(--space-xl);
            padding-bottom: var(--space-lg);
            border-bottom: 2px solid var(--border-subtle);
        }
        
        .lesson-icon {
            font-size: 40px;
            margin-bottom: var(--space-sm);
        }
        
        .lesson-title {
            font-size: 10px;
            color: var(--primary);
            margin-bottom: var(--space-xs);
            line-height: 1.5;
        }
        
        .lesson-subtitle {
            font-size: 7px;
            color: var(--secondary);
        }
        
        .teaching-section {
            background: var(--bg-elevated);
            border: 2px solid var(--primary);
            border-radius: var(--radius-md);
            padding: var(--space-lg);
            margin-bottom: var(--space-xl);
        }
        
        .teaching-text {
            font-size: 9px;
            line-height: 2;
            color: var(--primary);
            white-space: pre-wrap;
        }
        
        .concepts-section {
            margin-top: var(--space-xl);
        }
        
        .concept-card {
            background: var(--bg-dark);
            border-left: 4px solid var(--secondary);
            padding: var(--space-md);
            margin-bottom: var(--space-md);
            border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
        }
        
        .concept-title {
            font-size: 8px;
            color: var(--secondary);
            margin-bottom: var(--space-sm);
        }
        
        .concept-text {
            font-size: 8px;
            line-height: 1.8;
            color: var(--primary);
            opacity: 0.9;
        }
        
        .question-section {
            margin-bottom: var(--space-xl);
        }
        
        .question-progress {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-lg);
            padding-bottom: var(--space-md);
            border-bottom: 1px solid var(--border-subtle);
        }
        
        .progress-dots {
            display: flex;
            gap: var(--space-xs);
        }
        
        .progress-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--border-subtle);
            border: 1px solid var(--text-muted);
        }
        
        .progress-dot.current {
            background: var(--primary);
            border-color: var(--primary);
            box-shadow: 0 0 8px var(--primary);
        }
        
        .progress-dot.correct {
            background: var(--success);
            border-color: var(--success);
        }
        
        .progress-dot.incorrect {
            background: var(--danger);
            border-color: var(--danger);
        }
        
        .score-display {
            font-size: 7px;
            color: var(--primary);
        }
        
        .score-value {
            color: var(--secondary);
        }
        
        .question-text {
            font-size: 10px;
            line-height: 1.8;
            color: var(--secondary);
            margin-bottom: var(--space-xl);
            padding: var(--space-lg);
            background: var(--bg-elevated);
            border-radius: var(--radius-md);
            border: 2px solid var(--secondary);
        }
        
        .answers-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }
        
        .answer-btn {
            background: var(--bg-card);
            border: var(--border-width) solid var(--primary);
            color: var(--primary);
            font-family: inherit;
            font-size: 8px;
            line-height: 1.7;
            padding: var(--space-lg);
            text-align: left;
            cursor: pointer;
            border-radius: var(--radius-md);
            transition: all 0.15s ease;
        }
        
        .answer-btn:active:not(.disabled) {
            transform: scale(0.98);
            background: var(--bg-elevated);
        }
        
        .answer-btn.correct {
            border-color: var(--success);
            background: rgba(0, 255, 0, 0.1);
            animation: correctPulse 0.4s ease;
        }
        
        .answer-btn.incorrect {
            border-color: var(--danger);
            background: rgba(255, 0, 0, 0.15);
            animation: shake 0.4s ease;
        }
        
        .answer-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        @keyframes correctPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20% { transform: translateX(-8px); }
            40% { transform: translateX(8px); }
            60% { transform: translateX(-4px); }
            80% { transform: translateX(4px); }
        }
        
        .feedback-box {
            margin-top: var(--space-lg);
            padding: var(--space-lg);
            border-radius: var(--radius-md);
            font-size: 8px;
            line-height: 1.8;
            display: none;
        }
        
        .feedback-box.show {
            display: block;
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .feedback-box.correct {
            background: rgba(0, 255, 0, 0.1);
            border: 2px solid var(--success);
            color: var(--success);
        }
        
        .feedback-box.incorrect {
            background: rgba(255, 0, 0, 0.1);
            border: 2px solid var(--danger);
            color: #ff6666;
        }
        
        .modal-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.98);
            backdrop-filter: blur(10px);
            padding: var(--space-md);
            padding-bottom: calc(var(--space-md) + var(--safe-bottom));
            display: flex;
            gap: var(--space-md);
            z-index: 1001;
        }
        
        .btn {
            flex: 1;
            font-family: inherit;
            font-size: 8px;
            padding: var(--space-md) var(--space-lg);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.15s ease;
            min-height: var(--touch-target);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-sm);
        }
        
        .btn:active {
            transform: scale(0.97);
        }
        
        .btn-primary {
            background: rgba(255, 0, 0, 0.1);
            border: var(--border-width) solid var(--primary);
            color: var(--primary);
        }
        
        .btn-primary:active {
            background: rgba(255, 0, 0, 0.2);
        }
        
        .btn-secondary {
            background: transparent;
            border: 2px solid var(--text-muted);
            color: var(--text-muted);
        }
        
        .btn-accent {
            background: rgba(255, 255, 0, 0.1);
            border: var(--border-width) solid var(--secondary);
            color: var(--secondary);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        .completion-screen {
            text-align: center;
            padding: var(--space-2xl) 0;
        }
        
        .completion-icon {
            font-size: 64px;
            margin-bottom: var(--space-lg);
            animation: bounce 1s ease infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }
        
        .completion-title {
            font-size: 14px;
            color: var(--primary);
            margin-bottom: var(--space-md);
            text-shadow: 0 0 20px rgba(255, 0, 0, 0.5);
        }
        
        .completion-xp {
            font-size: 12px;
            color: var(--secondary);
            margin-bottom: var(--space-xl);
        }
        
        .completion-stats {
            background: var(--bg-elevated);
            border: 2px solid var(--primary);
            border-radius: var(--radius-md);
            padding: var(--space-xl);
            margin-bottom: var(--space-xl);
        }
        
        .completion-stats p {
            font-size: 9px;
            line-height: 2;
            margin-bottom: var(--space-sm);
        }
        
        .toast {
            position: fixed;
            bottom: calc(80px + var(--safe-bottom));
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-elevated);
            border: 2px solid var(--primary);
            padding: var(--space-md) var(--space-xl);
            border-radius: var(--radius-md);
            font-size: 8px;
            color: var(--primary);
            z-index: 2000;
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        
        @media (min-width: 768px) {
            :root {
                --space-md: 16px;
                --space-lg: 20px;
                --space-xl: 32px;
            }
            
            .title { font-size: 12px; }
            
            .skill-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
            }
            
            .skill-card:hover:not(.locked) {
                transform: translateY(-2px);
                box-shadow: 0 0 20px rgba(255, 0, 0, 0.2);
            }
            
            .teaching-text, .question-text { font-size: 10px; }
            .answer-btn { font-size: 9px; }
            
            .answer-btn:hover:not(.disabled) {
                background: var(--bg-elevated);
                border-color: var(--secondary);
            }
        }
        
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <h1 class="title">‚ö° SHORT-TERM DYNAMIC PSYCHOTHERAPY ‚ö°</h1>
            <p class="subtitle">ISTDP - INTENSIVE AFFECT-FOCUSED WORK</p>
            
            <div class="xp-section">
                <div class="xp-bar-outer">
                    <div class="xp-bar-fill" id="xp-bar"></div>
                    <div class="xp-text" id="xp-text">0 / 100 XP</div>
                </div>
            </div>
            
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-label">LEVEL</div>
                    <div class="stat-value" id="level-display">1</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">MASTERY</div>
                    <div class="stat-value" id="mastery-display">0%</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">STREAK</div>
                    <div class="stat-value" id="streak-display">0üî•</div>
                </div>
            </div>
        </div>
    </header>
    
    <main class="main-content">
        <div class="path-indicator">
            CURRENT PATH: <span class="path-name" id="current-path">FOUNDATIONS</span>
        </div>
        <div class="skill-grid" id="skill-grid"></div>
    </main>
    
    <nav class="bottom-nav">
        <div class="nav-buttons">
            <button class="nav-btn home-btn" onclick="goHome()"><span class="icon">üè†</span><span>HOME</span></button>
            <button class="nav-btn" onclick="saveProgress()"><span class="icon">üíæ</span><span>SAVE</span></button>
            <button class="nav-btn" onclick="loadProgress()"><span class="icon">üìÅ</span><span>LOAD</span></button>
            <button class="nav-btn" onclick="resetProgress()"><span class="icon">üîÑ</span><span>RESET</span></button>
        </div>
    </nav>
    
    <div class="modal-overlay" id="modal">
        <div class="modal-content" id="modal-content"></div>
    </div>
    
    <div class="toast" id="toast"></div>
    
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script>
        let gameState = {
            level: 1, xp: 0, xpToNextLevel: 100, totalXp: 0, streak: 0,
            completedSkills: [], skillProgress: {}, currentLesson: null,
            currentQuestion: 0, correctAnswers: 0, questionResults: []
        };
        
        const skillTree = [
            {
                id: 'triangle-conflict',
                title: 'Triangle of Conflict',
                icon: 'üî∫',
                level: 1,
                xp: 20,
                prereq: null,
                lessons: [{
                    title: 'The Core Model',
                    teaching: `The TRIANGLE OF CONFLICT is the foundational map of ISTDP.

THREE CORNERS:
1. IMPULSE/FEELING (bottom left): True emotion - rage, grief, guilt, love.
2. ANXIETY (bottom right): Body's danger signal when feeling approaches.
3. DEFENSE (top): What you do to AVOID feeling and anxiety.

The pattern: FEELING arises ‚Üí triggers ANXIETY ‚Üí activates DEFENSE.

ISTDP works by: helping client SEE this pattern, build capacity to BEAR anxiety, dismantle defenses, access TRUE FEELING.`,
                    concepts: [
                        { title: 'Why Feelings Create Anxiety', text: 'Feelings became dangerous in past - expressing anger got punishment, showing sadness led to rejection. Psyche learned: "This feeling = threat." Now even POTENTIAL of feeling triggers anxiety.' },
                        { title: 'Defenses Are Solutions', text: 'Defenses aren\'t bad - they WORKED. They protected you. Problem: they persist when no longer needed, prevent intimacy/growth. ISTDP respects defenses while showing their cost.' }
                    ],
                    questions: [
                        {
                            question: 'Client says "I\'m frustrated with my partner" but smiles and laughs. Using Triangle of Conflict, what\'s happening?',
                            answers: [
                                { text: 'They\'re not actually frustrated', correct: false, feedback: 'The verbal content IS real. The smile is DEFENSE against the feeling.' },
                                { text: 'DEFENSE (smiling) covers FEELING (anger) to avoid ANXIETY', correct: true, feedback: 'PERFECT! Triangle at work: IMPULSE = anger. ANXIETY = danger signal. DEFENSE = smile to neutralize. Point to the defense, invite dropping it.' },
                                { text: 'Neurological problem', correct: false, feedback: 'This is psychological defense - very common pattern.' },
                                { text: 'Ignore the smile', correct: false, feedback: 'The smile IS the clinical data! ISTDP points to defenses like this.' }
                            ]
                        },
                        {
                            question: 'What\'s the role of ANXIETY in the triangle?',
                            answers: [
                                { text: 'Enemy to eliminate', correct: false, feedback: 'Anxiety is SIGNAL system. Can\'t eliminate it, work with it.' },
                                { text: 'Signal that feeling is approaching - warns "danger ahead" based on past conditioning', correct: true, feedback: 'YES! Anxiety is ALARM SYSTEM. ISTDP tracks it: Where in body? What pathway? Too much = overwhelm. Just right = can work.' },
                                { text: 'Only in anxious people', correct: false, feedback: 'Everyone experiences anxiety when approaching unconscious feelings!' },
                                { text: 'Same as feeling', correct: false, feedback: 'Anxiety is RESPONSE to feeling. Feeling = emotion itself. Different.' }
                            ]
                        },
                        {
                            question: 'Why focus on identifying defenses rather than just exploring feelings?',
                            answers: [
                                { text: 'Defenses more important', correct: false, feedback: 'Both matter! But defenses BLOCK access to feelings.' },
                                { text: 'Defenses prevent access to true feelings - must be seen first', correct: true, feedback: 'EXACTLY! Can\'t access feeling while defense operates. Like trying to open door while someone holds it shut.' },
                                { text: 'Feelings don\'t matter', correct: false, feedback: 'Feelings are CENTRAL! But accessed through defense work.' },
                                { text: 'Defenses can\'t change', correct: false, feedback: 'Defenses CAN be relinquished when client sees cost.' }
                            ]
                        }
                    ]
                }]
            },
            {
                id: 'triangle-person',
                title: 'Triangle of Person',
                icon: 'üë•',
                level: 1,
                xp: 20,
                prereq: 'triangle-conflict',
                lessons: [{
                    title: 'Tracking Patterns Across Relationships',
                    teaching: `The TRIANGLE OF PERSON tracks WHERE feelings/defenses show up:

1. CURRENT RELATIONSHIPS: Partner, friends, boss
2. PAST RELATIONSHIPS: Parents, siblings, early figures  
3. THERAPIST (Transference): Feelings toward you in the room

Same conflict plays out in all three! Client angry at partner may have been angry at mother, and is now subtly angry at YOU.

ISTDP uses therapist corner actively - examining feelings toward therapist IN THE MOMENT uncovers deepest material fastest.`,
                    concepts: [
                        { title: 'Why Therapist Corner Matters', text: 'Transference = client unconsciously brings patterns INTO session. This is LIVE DATA - not just talking about feelings but having them with you. Most powerful place to work because it\'s happening NOW.' },
                        { title: 'Linking the Triangles', text: 'Defense in current relationship links to past: "You go silent with wife (current) like you did with critical father (past). And I notice you went quiet just now with me (therapist)." This pattern spans all three corners.' }
                    ],
                    questions: [
                        {
                            question: 'Client describes feeling controlled by boss. They mention father was controlling. Now they\'re excessively agreeable with you. What do you notice?',
                            answers: [
                                { text: 'Client is just polite', correct: false, feedback: 'COMPLIANCE in room (toward you) mirrors pattern with boss and father! This is transference.' },
                                { text: 'Same pattern across triangle - controlling figures evoke compliance. Point to this: "You comply with boss like with father - and I notice you agree with everything I say..."', correct: true, feedback: 'EXACTLY! Pattern visible in all three corners. Work with it in therapist corner: "What happens inside when you just agree with me? Is there another feeling beneath the compliance?"' },
                                { text: 'Focus only on father', correct: false, feedback: 'All three corners matter! Working with live transference is most powerful entry point.' },
                                { text: 'Ignore the compliance', correct: false, feedback: 'The compliance IS the material! It\'s live demonstration of the defense.' }
                            ]
                        },
                        {
                            question: 'Why work with feelings toward therapist (transference) instead of just talking about past?',
                            answers: [
                                { text: 'Past doesn\'t matter', correct: false, feedback: 'Past matters deeply! But transference shows past ALIVE in present.' },
                                { text: 'Transference is live data - emotions are happening NOW, not just remembered, making them accessible for real change', correct: true, feedback: 'YES! Difference between TALKING about anger (past) vs FEELING anger toward you (present). Live emotion is workable. Transference brings past into room where it can be metabolized.' },
                                { text: 'Therapist more important than parents', correct: false, feedback: 'Not about importance! Therapist corner provides access to patterns formed with parents.' },
                                { text: 'Avoid difficult memories', correct: false, feedback: 'We work with difficult material! Transference is direct path TO that material.' }
                            ]
                        },
                        {
                            question: 'Client starts every sentence with "I don\'t know if this is right but..." When you point this out, they apologize. What\'s the link?',
                            answers: [
                                { text: 'They\'re just uncertain', correct: false, feedback: 'Pattern of seeking permission/approval is defense. Apologizing when pointed out = MORE of same pattern!' },
                                { text: 'Self-deprecation is defense operating NOW - likely mirrors pattern with critical past figures. Explore: "Who taught you to apologize for having thoughts?"', correct: true, feedback: 'EXCELLENT! The apology AFTER you point it out is same defense in action. This links to past: Who was critical? Who made them feel their thoughts were wrong? Explore in therapist corner first: "What\'s it like to have me notice this pattern?"' },
                                { text: 'Accept the apology', correct: false, feedback: 'Accepting colludes with defense. Point to pattern instead.' },
                                { text: 'Change subject', correct: false, feedback: 'This IS the subject! The defense is live and workable.' }
                            ]
                        }
                    ]
                }]
            },
            {
                id: 'pressure-challenge',
                title: 'Pressure & Challenge',
                icon: 'üî•',
                level: 1,
                xp: 25,
                prereq: 'triangle-person',
                lessons: [{
                    title: 'The Heat of the Work',
                    teaching: `PRESSURE = actively inviting client toward feeling, not passively listening. CHALLENGE = directly addressing defenses.

ISTDP is NOT: passive, exclusively supportive, slow-paced.
ISTDP IS: active, challenging, pressing toward unconscious feeling.

This requires: Strong alliance, careful assessment of capacity, continuous tracking of anxiety pathway. Pressure without attunement = harm. But attunement without pressure = stagnation.

Balance: "I care about you AND I won't let you hide from your feelings."`,
                    concepts: [
                        { title: 'Therapeutic Pressure', text: 'Not attack or aggression. Persistent, caring focus on what client avoids. "I notice you changed subject when sadness came. What would it be like to stay with the sadness?" Firm but warm. High warmth + high challenge.' },
                        { title: 'When to Back Off', text: 'If anxiety goes to cognitive-perceptual pathway (spacing out, vision blur) = STOP. Client is overwhelmed. Regulate first. Pressure only effective within window of tolerance.' }
                    ],
                    questions: [
                        {
                            question: 'You ask about anger toward mother. Client gives vague answer and changes subject. What\'s ISTDP approach?',
                            answers: [
                                { text: 'Follow new subject', correct: false, feedback: 'Following = colluding with defense. The avoidance IS the material.' },
                                { text: 'Point to defense and press back: "I notice you moved away from anger. Can we go back? What do you notice when I ask about anger toward mother?"', correct: true, feedback: 'PERFECT ISTDP! Name the defense (changing subject), invite return to feeling. Don\'t lecture about defense - just point and redirect. Pressure is: "Let\'s stay with this."' },
                                { text: 'Tell them they\'re difficult', correct: false, feedback: 'Judgmental, breaks alliance. Challenge BEHAVIOR, not person.' },
                                { text: 'Give up on anger', correct: false, feedback: 'Anger is likely core issue! Persist with appropriate pressure.' }
                            ]
                        },
                        {
                            question: 'When is pressure contraindicated?',
                            answers: [
                                { text: 'Never - always maximum pressure', correct: false, feedback: 'Dangerous! Too much pressure with fragile client = decompensation.' },
                                { text: 'When anxiety goes to cognitive-perceptual disruption - client is overwhelmed, need to build capacity first', correct: true, feedback: 'CRITICAL SAFETY! If client shows spacing out, vision blur = STOP pressure. Regulate, build capacity. Pressuring fragile client = retraumatizing.' },
                                { text: 'Pressure is never appropriate', correct: false, feedback: 'ISTDP is built on appropriate pressure! Must match client capacity.' },
                                { text: 'Only when client asks', correct: false, feedback: 'Therapist must track anxiety pathway. Client may not ask even when overwhelmed.' }
                            ]
                        },
                        {
                            question: 'Difference between CHALLENGE and being confrontational?',
                            answers: [
                                { text: 'No difference', correct: false, feedback: 'Big difference! Challenge is compassionate. Confrontation is hostile.' },
                                { text: 'CHALLENGE points to PATTERN with compassion. Confrontation attacks PERSON.', correct: true, feedback: 'PERFECT! Challenge: "This defense makes sense AND costs you." Confrontation: "You\'re resistant." Challenge targets behavior. Confrontation shames person. Firm but loving.' },
                                { text: 'Challenge = making client uncomfortable', correct: false, feedback: 'Discomfort isn\'t the goal - helping client SEE and relinquish defenses is.' },
                                { text: 'Only harsh confrontation creates change', correct: false, feedback: 'Harshness creates shame/shutdown. Compassionate challenge creates change.' }
                            ]
                        }
                    ]
                }]
            },
            {
                id: 'anxiety-pathways',
                title: 'Anxiety Pathways',
                icon: '‚ö°',
                level: 2,
                xp: 35,
                prereq: 'pressure-challenge',
                lessons: [{
                    title: 'Reading the Body',
                    teaching: `ISTDP maps three ANXIETY PATHWAYS:

1. STRIATED MUSCLE (Optimal): Tension in voluntary muscles - shoulders, jaw, fists. Client is MOBILIZING. Can tolerate affect work.

2. SMOOTH MUSCLE (Fragile): Gut, blood vessels affected - IBS, migraines, palpitations. System more overwhelmed. Gentle approach needed.

3. COGNITIVE-PERCEPTUAL (Very Fragile): Brain disrupted - vision blur, spacing out, dissociation. STOP pressure immediately, regulate.

Constantly ask: "Where do you notice that in your body?"`,
                    concepts: [
                        { title: 'Why Pathway Matters', text: 'Same feeling creates different responses based on nervous system resilience. Must match intervention to capacity or harm client. Striated = green light. Smooth = yellow. C-P = red.' },
                        { title: 'Building Capacity', text: 'Person can shift pathways! Smooth muscle ‚Üí striated through titrated exposure, regulation techniques. This is structural change - nervous system learning new patterns.' }
                    ],
                    questions: [
                        {
                            question: 'You ask about anger at father. Client says "My vision got blurry, I feel spacey." What do you do?',
                            answers: [
                                { text: 'Keep pressuring toward anger', correct: false, feedback: 'DANGEROUS! C-P pathway = dissociating. More pressure = more harm.' },
                                { text: 'STOP immediately. "Let\'s pause. Look around, what do you see? Feel your feet on floor." REGULATE first.', correct: true, feedback: 'EXACTLY! Vision blur + spacey = RED LIGHT. Stop everything, ground, regulate. THEN assess: is this characteristic or unusual? May need months of capacity building.' },
                                { text: 'Tell them they\'re resisting', correct: false, feedback: 'This is FRAGILITY not resistance! Blaming harms.' },
                                { text: 'Continue and hope it passes', correct: false, feedback: 'Ignoring risks serious harm. Dissociation can worsen.' }
                            ]
                        },
                        {
                            question: 'Client reports: "My shoulders are tight, jaw is clenched." What does this tell you?',
                            answers: [
                                { text: 'They need massage', correct: false, feedback: 'This is ANXIETY in striated muscle - psychological, not structural!' },
                                { text: 'STRIATED pathway - good sign! Can tolerate affect work. "That tension - what\'s it getting ready to DO?"', correct: true, feedback: 'YES! Striated = GREEN LIGHT. System mobilizing. Use it: "Those clenched fists - what would they do?" Tension IS rage trying to express.' },
                                { text: 'Client is faking', correct: false, feedback: 'These are real somatic manifestations!' },
                                { text: 'Stop all affect work', correct: false, feedback: 'Opposite! Striated = can HANDLE work. Go deeper.' }
                            ]
                        },
                        {
                            question: 'Why ask "Where do you notice that in your body?"',
                            answers: [
                                { text: 'To distract', correct: false, feedback: 'Not distraction - this IS emotional content! Feelings live in body.' },
                                { text: 'Track pathway (safety), guide intervention, keep client in felt experience', correct: true, feedback: 'EXACTLY! Multiple functions: SAFETY (pathway guides intensity), TRACKING (building or declining?), ACCESS (emotions embodied), TEACHING (builds interoception). Most important ISTDP question!' },
                                { text: 'ISTDP is body-only therapy', correct: false, feedback: 'ISTDP integrates cognitive, emotional, somatic, relational. Not purely somatic.' },
                                { text: 'Make sessions longer', correct: false, feedback: 'ISTDP is SHORT-term! Body focus speeds access by bypassing cognitive defenses.' }
                            ]
                        }
                    ]
                }]
            },
            {
                id: 'defense-restructuring',
                title: 'Defense Restructuring',
                icon: 'üõ°Ô∏è',
                level: 2,
                xp: 40,
                prereq: 'anxiety-pathways',
                lessons: [{
                    title: 'Systematic Dismantling',
                    teaching: `DEFENSE RESTRUCTURING:
1. SEE defenses (build awareness)
2. Understand COST (what defense prevents)
3. RELINQUISH (choose feeling instead)

Not attacking defenses. Creating conditions where client CHOOSES to drop defense: "This protected me once but now imprisons me."

Process: Label ‚Üí Point to cost ‚Üí Build alliance against it ‚Üí Invite dropping ‚Üí Support bearing feeling beneath.`,
                    concepts: [
                        { title: 'Defenses vs Character', text: 'Challenge the DEFENSE not PERSON. "This pattern prevents intimacy" NOT "You prevent intimacy." Defense is behavior that can change. Frame as: "This defense is your enemy, let\'s fight together."' },
                        { title: 'When Defense Won\'t Budge', text: 'If client clings despite challenge: Fear too great (need more capacity), secondary gain, timing off, or characterological (longer work needed). Respect resistance, adjust approach.' }
                    ],
                    questions: [
                        {
                            question: 'Client responds with "I don\'t know" to everything, even things they clearly know. How restructure?',
                            answers: [
                                { text: 'Accept and move on', correct: false, feedback: 'This colludes with defense. "I don\'t know" is avoidance.' },
                                { text: 'Label it, point to cost, challenge: "\'I don\'t know\' is a way of not looking. If we don\'t look, we can\'t help. Could we try looking together?"', correct: true, feedback: 'PERFECT sequence! Label, reframe, cost, invitation. If still resists: "What would happen if you DID know?"' },
                                { text: 'Tell them they\'re lying', correct: false, feedback: 'It\'s unconscious defense, not lie. Accusation breaks alliance.' },
                                { text: 'Give multiple choice', correct: false, feedback: 'This enables defense. ISTDP invites client to do the looking.' }
                            ]
                        },
                        {
                            question: 'Purpose of pointing to COST of defenses?',
                            answers: [
                                { text: 'To shame', correct: false, feedback: 'Never! Cost creates MOTIVATION, not shame. Done with compassion.' },
                                { text: 'Create motivation - when client sees what defense PREVENTS, they become willing to try differently', correct: true, feedback: 'YES! Make implicit explicit: "This deflecting keeps you stuck, isolated. Worth it?" When cost is visible and felt, motivation shifts.' },
                                { text: 'Defenses have no function', correct: false, feedback: 'Defenses DO function - protection! But also cost. Emphasize cost to create motivation.' },
                                { text: 'Prove therapist is right', correct: false, feedback: 'Not about being right! About helping client see pattern so THEY can choose.' }
                            ]
                        },
                        {
                            question: 'Client becomes compliant after challenge - agrees with everything, tries to be "good patient." What\'s happening?',
                            answers: [
                                { text: 'Genuine change', correct: false, feedback: 'Too fast. More likely this IS defense - compliance replacing previous one.' },
                                { text: 'COMPLIANCE is defense - appearing to cooperate while avoiding. Must challenge this too.', correct: true, feedback: 'EXCELLENT! Compliance is sneaky - looks cooperative but avoids real feeling. "I notice you agree with everything. Where are YOUR feelings? Any frustration at my challenging?"' },
                                { text: 'Stop challenging', correct: false, feedback: 'Stopping colludes with new defense. Real success = authentic response, not polite agreement.' },
                                { text: 'Increase pressure', correct: false, feedback: 'More pressure often = more compliance. NAME it directly instead.' }
                            ]
                        }
                    ]
                }]
            },
            {
                id: 'unlocking-unconscious',
                title: 'Unlocking the Unconscious',
                icon: 'üîì',
                level: 2,
                xp: 35,
                prereq: 'defense-restructuring',
                lessons: [{
                    title: 'The Breakthrough',
                    teaching: `UNLOCKING = moment defenses drop and true feeling emerges.

Signs:
- Shift from intellectual to visceral
- Body activates dramatically
- Affect floods - rage, grief
- Previously unavailable material surfaces
- Direct eye contact
- "I" statements replace "you/one"

NOT catharsis for its own sake - EXPERIENCING repressed feeling so it can be METABOLIZED.`,
                    concepts: [
                        { title: 'Different from Catharsis', text: 'Pure catharsis without structure can retraumatize. ISTDP unlocking is: Prepared (defenses weakened), Supported, Structured (tracked, linked), Integrated (meaning made). This makes it therapeutic.' },
                        { title: 'After Unlocking', text: 'Relief, clarity, often immediate symptom reduction. Then consolidation - integrate insight, test new behaviors. One unlocking rarely "cures" but shifts something fundamental.' }
                    ],
                    questions: [
                        {
                            question: 'Client suddenly stops mid-sentence, face flushes, fists clench, eyes well up. What\'s happening and what do you do?',
                            answers: [
                                { text: 'Panic attack, call 911', correct: false, feedback: 'Not panic! This is BREAKTHROUGH. Exactly what ISTDP works toward.' },
                                { text: 'UNLOCKING - defenses dropped. Say: "Stay with that. What\'s happening in your body? Let it come."', correct: true, feedback: 'PERFECT! Support, track, don\'t interrupt. "Those fists - what do they want to do?" Help them BEAR and COMPLETE. Afterward: integrate, link to pattern.' },
                                { text: 'Distract them', correct: false, feedback: 'NO! This is precious moment. Stay WITH activation.' },
                                { text: 'Tell them to calm down', correct: false, feedback: 'Opposite! They need to GO INTO feeling. "Let it intensify, I\'m with you."' }
                            ]
                        },
                        {
                            question: 'After intense session accessing rage at father, client calls next day feeling worse. What happened?',
                            answers: [
                                { text: 'Therapy harmed them', correct: false, feedback: 'Temporary increase post-unlocking is COMMON. This is integration.' },
                                { text: 'Normal post-unlocking - system reorganizing. Guilt often follows rage. Support through it.', correct: true, feedback: 'YES - EXPECTED! After rage: guilt, grief, disorientation as old defenses gone. This is WORKING. Next session: process what followed.' },
                                { text: 'Being dramatic', correct: false, feedback: 'Post-unlocking distress is real neurobiological reorganization.' },
                                { text: 'Did technique wrong', correct: false, feedback: 'Temporary worsening often means technique worked! Material is being processed.' }
                            ]
                        },
                        {
                            question: 'Difference between healthy unlocking and retraumatization?',
                            answers: [
                                { text: 'No difference', correct: false, feedback: 'Huge difference! Unlocking is structured. Retraumatization is flooding.' },
                                { text: 'UNLOCKING: Client can bear, stays in striated muscle, integrates. RETRAUMATIZATION: floods C-P, dissociates, no integration', correct: true, feedback: 'CRITICAL! Healthy: adequate prep, capacity assessed, titrated, bearing not flooding, integration follows. Retraumatization: premature, exceeds capacity, overwhelmed. This is why assessment crucial!' },
                                { text: 'All intensity is harmful', correct: false, feedback: 'Intensity within window is HEALING. Avoiding keeps client stuck.' },
                                { text: 'Only medication prevents retraumatization', correct: false, feedback: 'Skilled assessment and titration prevents it.' }
                            ]
                        }
                    ]
                }]
            },
            {
                id: 'character-resistance',
                title: 'Character Resistance',
                icon: 'üß±',
                level: 3,
                xp: 45,
                prereq: 'unlocking-unconscious',
                lessons: [{
                    title: 'When Defense IS Identity',
                    teaching: `CHARACTER RESISTANCE: Defense patterns woven into personality. "I'm just a cold person" (detachment as identity). "I always put others first" (caretaking as identity).

These are EGO-SYNTONIC - feel like self, not problem. Harder to work with.

ISTDP approach:
1. Point to PATTERN across situations
2. Show COST
3. Frame as PRISON not identity
4. Explore PAYOFF

Longer work usually needed.`,
                    concepts: [
                        { title: 'Ego-Syntonic vs Dystonic', text: 'DYSTONIC: "I know I shouldn\'t avoid but can\'t help it." Client wants change. SYNTONIC: "This is just who I am." No dissonance. Must CREATE awareness it\'s problem first.' },
                        { title: 'Why Character Defenses Persist', text: 'They\'re IDENTITY protective. If "I\'m stoic" is identity, feeling = losing self. Dismantling requires building NEW identity, not just dropping defense.' }
                    ],
                    questions: [
                        {
                            question: 'Client says "I\'m just a detached person, I don\'t do emotions. That\'s who I am." No distress about it. How intervene?',
                            answers: [
                                { text: 'Accept it', correct: false, feedback: 'They came to therapy for reason! Must explore cost to create motivation.' },
                                { text: 'Point to cost: "What\'s the price? What does detachment prevent? Why therapy if it works so well?"', correct: true, feedback: 'EXCELLENT! Create DISSONANCE. "If fine, why lonely/anxious/in therapy?" When cost visible, defense becomes problem. Then explore: "When did you become detached? What was happening?"' },
                                { text: 'Tell them they\'re wrong', correct: false, feedback: 'Invalidating. Help them DISCOVER cost, don\'t tell them.' },
                                { text: 'Give up', correct: false, feedback: 'Character CAN change - needs patient, longer work.' }
                            ]
                        },
                        {
                            question: 'Client is chronic caretaker - compulsively helps others, never receives. Sees as virtue. ISTDP understanding?',
                            answers: [
                                { text: 'Genuinely generous, affirm', correct: false, feedback: 'COMPULSIVE helping is defense! Lack of receiving is problem.' },
                                { text: 'Character defense against vulnerability of needing - if I help I\'m strong, if I need I\'m weak', correct: true, feedback: 'EXACTLY! Caretaking defends against neediness that felt shameful/dangerous in childhood. "What happens when someone gives to YOU?" Usually discomfort. Must work with shame about needs.' },
                                { text: 'Focus elsewhere', correct: false, feedback: 'This IS the issue! Creates burnout, resentment, lonely relationships.' },
                                { text: 'Tell them to stop helping', correct: false, feedback: 'Can\'t just stop - must address WHY compulsive. What does it defend against?' }
                            ]
                        },
                        {
                            question: 'Why is character resistance challenging for time-limited ISTDP?',
                            answers: [
                                { text: 'Same as any defense', correct: false, feedback: 'Character defenses ARE harder - deeply embedded, ego-syntonic.' },
                                { text: 'Identity-level, ego-syntonic, needs longer treatment - may need extended work', correct: true, feedback: 'IMPORTANT! ISTDP excels with discrete traumas, neurotic defenses. Character-level often needs: longer treatment, more relational focus, patience. Knowing when longer work needed = clinical wisdom.' },
                                { text: 'More pressure solves it', correct: false, feedback: 'More pressure on character defense = increased rigidity or rupture.' },
                                { text: 'Character can\'t change', correct: false, feedback: 'CAN change! Needs appropriate timeframe.' }
                            ]
                        }
                    ]
                }]
            },
            {
                id: 'istdp-mastery',
                title: 'Integration & Mastery',
                icon: 'üéØ',
                level: 3,
                xp: 50,
                prereq: 'character-resistance',
                lessons: [{
                    title: 'The Art of ISTDP',
                    teaching: `MASTERY = holding multiple tasks simultaneously:
- Track TWO triangles at once
- Monitor anxiety pathway continuously
- Identify/challenge defenses in moment
- Assess capacity, titrate pressure
- Stay present while being technical
- Build alliance while creating discomfort
- Know when to push, back off, sit in silence

Both art AND science. Most important: BELIEVING in client's capacity.`,
                    concepts: [
                        { title: 'When ISTDP Works Best', text: 'Ideal: Motivated client, neurotic defenses, discrete trauma, good capacity (striated), strong ego. Single session breakthroughs possible when assessment accurate, timing right, client ready.' },
                        { title: 'Ongoing Learning', text: 'Requires: Formal training, video review, supervision, study, personal therapy. Not modality to learn from books alone - need experiential training.' }
                    ],
                    questions: [
                        {
                            question: 'Most important skill for ISTDP therapist?',
                            answers: [
                                { text: 'Memorizing techniques', correct: false, feedback: 'Techniques matter but aren\'t sufficient alone.' },
                                { text: 'Bearing client\'s intense affect without defending - staying regulated, believing in their strength', correct: true, feedback: 'THIS IS IT! Can\'t help client bear what you can\'t bear. If their rage triggers YOUR anxiety, you\'ll defend. Must be regulated as they activate. This is why personal therapy crucial.' },
                                { text: 'Being aggressive', correct: false, feedback: 'ISTDP is firm but compassionate, not aggressive.' },
                                { text: 'Making client cry', correct: false, feedback: 'Tears aren\'t goal! UNLOCKING is goal - might be rage, quiet realization.' }
                            ]
                        },
                        {
                            question: 'Client presents with: active suicidal plan, recent psychosis, severe DID. Use ISTDP?',
                            answers: [
                                { text: 'Yes, works for everyone', correct: false, feedback: 'DANGEROUS! ISTDP has contraindications.' },
                                { text: 'NO - contraindicated. Need safety/stabilization first, possibly different modality', correct: true, feedback: 'CRITICAL! Contraindicated for: active psychosis, acute suicide risk, severe dissociation. Need DBT, stabilization, maybe medication first. MAYBE adapted ISTDP later.' },
                                { text: 'Just use less pressure', correct: false, feedback: 'Not about pressure amount - these need fundamentally different approach.' },
                                { text: 'ISTDP cures psychosis', correct: false, feedback: 'Absolutely not! Psychosis needs medical intervention first.' }
                            ]
                        },
                        {
                            question: 'After years of practice, what should ISTDP therapist continue?',
                            answers: [
                                { text: 'Nothing - know it all', correct: false, feedback: 'Hubris! Always more to learn.' },
                                { text: 'Supervision, video review, training, personal therapy - continuous learning', correct: true, feedback: 'YES! Even experts need: supervision (blind spots), video review, training (field evolves), personal therapy (own blocks). Your unworked defenses limit work with clients.' },
                                { text: 'Only easy clients', correct: false, feedback: 'Growth comes from challenge!' },
                                { text: 'Switch modalities', correct: false, feedback: 'With proper support, ISTDP is sustainable.' }
                            ]
                        }
                    ]
                }]
            }
        ];
        
        function initUI() { updateStats(); renderSkillGrid(); }
        
        function updateStats() {
            const xpPercent = (gameState.xp / gameState.xpToNextLevel) * 100;
            const mastery = Math.round((gameState.completedSkills.length / skillTree.length) * 100);
            const currentPath = gameState.level <= 1 ? 'FOUNDATIONS' : gameState.level <= 2 ? 'INTERMEDIATE' : 'ADVANCED';
            
            document.getElementById('xp-bar').style.width = `${xpPercent}%`;
            document.getElementById('xp-text').textContent = `${gameState.xp} / ${gameState.xpToNextLevel} XP`;
            document.getElementById('level-display').textContent = gameState.level;
            document.getElementById('mastery-display').textContent = `${mastery}%`;
            document.getElementById('streak-display').textContent = `${gameState.streak}üî•`;
            document.getElementById('current-path').textContent = currentPath;
        }
        
        function renderSkillGrid() {
            const grid = document.getElementById('skill-grid');
            grid.innerHTML = skillTree.map(skill => {
                const isCompleted = gameState.completedSkills.includes(skill.id);
                const isUnlocked = !skill.prereq || gameState.completedSkills.includes(skill.prereq);
                let status = 'üîí', statusClass = 'locked';
                if (isCompleted) { status = '‚úì'; statusClass = 'completed'; }
                else if (isUnlocked) { status = '‚Üí'; statusClass = 'unlocked'; }
                
                return `<div class="skill-card ${statusClass}" onclick="${isUnlocked ? `startSkill('${skill.id}')` : ''}" role="button" tabindex="${isUnlocked ? '0' : '-1'}">
                    <div class="skill-icon">${skill.icon}</div>
                    <div class="skill-info">
                        <div class="skill-title">${skill.title}</div>
                        <div class="skill-meta"><span class="skill-xp">+${skill.xp} XP</span><span>Level ${skill.level}</span></div>
                    </div>
                    <div class="skill-status">${status}</div>
                </div>`;
            }).join('');
            
            grid.querySelectorAll('.skill-card.unlocked').forEach(card => {
                card.addEventListener('keydown', e => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); card.click(); } });
            });
        }
        
        function startSkill(skillId) {
            const skill = skillTree.find(s => s.id === skillId);
            if (!skill) return;
            gameState.currentLesson = skill;
            gameState.currentQuestion = 0;
            gameState.correctAnswers = 0;
            gameState.questionResults = [];
            showLesson(skill);
        }
        
        function showLesson(skill) {
            const modal = document.getElementById('modal');
            const content = document.getElementById('modal-content');
            const lesson = skill.lessons[0];
            const concepts = lesson.concepts.map(c => `<div class="concept-card"><div class="concept-title">üìå ${c.title}</div><div class="concept-text">${c.text}</div></div>`).join('');
            
            content.innerHTML = `
                <div class="lesson-header"><div class="lesson-icon">${skill.icon}</div><h2 class="lesson-title">${lesson.title}</h2><div class="lesson-subtitle">+${skill.xp} XP on completion</div></div>
                <div class="teaching-section"><div class="teaching-text">${lesson.teaching}</div></div>
                <div class="concepts-section">${concepts}</div>
                <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">‚Üê Back</button><button class="btn btn-primary" onclick="startQuestions()">Start Quiz ‚Üí</button></div>
            `;
            
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            document.body.style.position = 'fixed';
            document.body.style.width = '100%';
            document.body.style.top = `-${window.scrollY}px`;
        }
        
        function startQuestions() { showQuestion(0); }
        
        function showQuestion(index) {
            const skill = gameState.currentLesson;
            const lesson = skill.lessons[0];
            const question = lesson.questions[index];
            const content = document.getElementById('modal-content');
            const total = lesson.questions.length;
            
            const dots = lesson.questions.map((_, i) => {
                let cls = 'progress-dot';
                if (i === index) cls += ' current';
                else if (i < index) cls += gameState.questionResults[i] ? ' correct' : ' incorrect';
                return `<div class="${cls}"></div>`;
            }).join('');
            
            const answers = question.answers.map((a, i) => `<button class="answer-btn" onclick="selectAnswer(${i})">${a.text}</button>`).join('');
            const scoreText = index > 0 ? `<span class="score-display">Score: <span class="score-value">${gameState.correctAnswers}/${index}</span></span>` : '';
            
            content.innerHTML = `
                <div class="lesson-header"><h2 class="lesson-title">${skill.title}</h2><div class="lesson-subtitle">Question ${index + 1} of ${total}</div></div>
                <div class="question-section">
                    <div class="question-progress"><div class="progress-dots">${dots}</div>${scoreText}</div>
                    <div class="question-text">${question.question}</div>
                    <div class="answers-list">${answers}</div>
                    <div class="feedback-box" id="feedback"></div>
                </div>
                <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">‚Üê Exit</button><div id="continue-container"></div></div>
            `;
            
            window.currentQuestionData = { question, index, total };
        }
        
        function selectAnswer(answerIndex) {
            const { question, index, total } = window.currentQuestionData;
            const answer = question.answers[answerIndex];
            const buttons = document.querySelectorAll('.answer-btn');
            const feedback = document.getElementById('feedback');
            const continueContainer = document.getElementById('continue-container');
            
            buttons.forEach(btn => btn.classList.add('disabled'));
            const selectedBtn = buttons[answerIndex];
            
            if (answer.correct) {
                selectedBtn.classList.add('correct');
                feedback.className = 'feedback-box correct show';
                feedback.innerHTML = `‚úì CORRECT! ${answer.feedback}`;
                gameState.correctAnswers++;
                gameState.questionResults.push(true);
            } else {
                selectedBtn.classList.add('incorrect');
                feedback.className = 'feedback-box incorrect show';
                feedback.innerHTML = `‚úó ${answer.feedback}`;
                gameState.questionResults.push(false);
            }
            
            const isLast = index >= total - 1;
            continueContainer.innerHTML = `<button class="btn btn-primary" onclick="${isLast ? 'completeSkill()' : 'nextQuestion()'}">${isLast ? 'See Results ‚Üí' : 'Continue ‚Üí'}</button>`;
        }
        
        function nextQuestion() { gameState.currentQuestion++; showQuestion(gameState.currentQuestion); }
        
        function completeSkill() {
            const skill = gameState.currentLesson;
            const total = skill.lessons[0].questions.length;
            const score = Math.round((gameState.correctAnswers / total) * 100);
            const xpEarned = skill.xp;
            
            gameState.xp += xpEarned; gameState.totalXp += xpEarned;
            while (gameState.xp >= gameState.xpToNextLevel) { gameState.xp -= gameState.xpToNextLevel; gameState.level++; gameState.xpToNextLevel = Math.floor(gameState.xpToNextLevel * 1.5); }
            if (!gameState.completedSkills.includes(skill.id)) { gameState.completedSkills.push(skill.id); gameState.streak++; }
            
            const currentIndex = skillTree.findIndex(s => s.id === skill.id);
            const nextSkill = skillTree.slice(currentIndex + 1).find(s => !s.prereq || gameState.completedSkills.includes(s.prereq));
            const content = document.getElementById('modal-content');
            const nextBtn = nextSkill && !gameState.completedSkills.includes(nextSkill.id) ? `<button class="btn btn-accent" onclick="startNextSkill('${nextSkill.id}')">Next: ${nextSkill.title} ‚Üí</button>` : '';
            
            content.innerHTML = `
                <div class="completion-screen">
                    <div class="completion-icon">${skill.icon}</div>
                    <h2 class="completion-title">SKILL MASTERED!</h2>
                    <div class="completion-xp">+${xpEarned} XP EARNED</div>
                    <div class="completion-stats"><p>Score: <span style="color:var(--secondary)">${score}%</span> (${gameState.correctAnswers}/${total})</p><p>Skill: "${skill.title}"</p><p>Keep building your ISTDP mastery!</p></div>
                </div>
                <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModalAndRefresh()">‚Üê Skill Tree</button>${nextBtn}</div>
            `;
            
            if (typeof confetti !== 'undefined') confetti({ particleCount: 80, spread: 60, origin: { y: 0.7 }, colors: ['#f00', '#ff0', '#0ff'] });
            saveProgress();
        }
        
        function startNextSkill(skillId) { closeModal(); setTimeout(() => startSkill(skillId), 200); }
        
        function closeModal() {
            const scrollY = document.body.style.top;
            document.getElementById('modal').classList.remove('active');
            document.body.style.overflow = ''; document.body.style.position = ''; document.body.style.width = ''; document.body.style.top = '';
            window.scrollTo(0, parseInt(scrollY || '0') * -1);
        }
        
        function closeModalAndRefresh() { closeModal(); updateStats(); renderSkillGrid(); }
        function saveProgress() { localStorage.setItem('stdpAcademy', JSON.stringify(gameState)); showToast('üíæ Progress saved!'); }
        function loadProgress() { const saved = localStorage.getItem('stdpAcademy'); if (saved) { gameState = JSON.parse(saved); updateStats(); renderSkillGrid(); showToast('‚úì Progress loaded!'); } else { showToast('No saved progress'); } }
        function resetProgress() { if (confirm('Reset all progress?')) { localStorage.removeItem('stdpAcademy'); location.reload(); } }
        function showToast(msg) { const t = document.getElementById('toast'); t.textContent = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2000); }
        function goHome() { window.location.href = 'learning-library-hub.html'; }
        
        document.addEventListener('keydown', e => {
            const modal = document.getElementById('modal');
            const isOpen = modal.classList.contains('active');
            if (e.key === 'Escape' && isOpen) closeModal();
            if (!isOpen) { if (e.key === 'h') goHome(); if (e.key === 's') { e.preventDefault(); saveProgress(); } }
        });
        
        document.addEventListener('DOMContentLoaded', () => { const saved = localStorage.getItem('stdpAcademy'); if (saved) gameState = JSON.parse(saved); initUI(); });
    </script>
</body>
</html>
